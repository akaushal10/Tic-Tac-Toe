<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=yes">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
    <link href='https://fonts.googleapis.com/css?family=Ewert' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Dekko' rel='stylesheet'>
    <link rel="shortcut icon" href="./tab-icon.png" type="image/x-icon">
    <script src="./confetti.js"></script>
    <script src="./confetti-1.js"></script>
    <title>TIC TAC TOE</title>
    <style>
      body {
      font-family: 'Ewert';
      background-color: #ee8383;
      background-image: url("./bg-1.png");
      background-repeat: no-repeat;
      background-position-x:left;
      background-position-y: top;
      background-size:100%;

    }
    @media screen and (max-width:780px) {
    body{
      background-image: url('./bg-3.png');
      background-repeat: repeat-y;
    }
  }
    </style>
  </head>
  <body style="overflow-x: hidden;" class="container-fluid">
    <div class="row">
      <div id="game-header" class="col-12 text-center mx-auto row my-4 my-md-1">
        <span class="mx-auto col-md-5 col-12">TIC TAC TOE</span>
      </div>
      <div id="player-1" class="col-5 col-md-4 mx-auto text-center">
        <div class="player-name" >User</div>
        <div class="player-score" >0</div>
      </div>
      <div id="player-3" class="col-5 col-md-4 mx-auto text-center d-md-none">
        <div class="player-name" >Computer</div>
        <div class="player-score" >0</div>
      </div>
      <div id="game-board" class="col-10 col-md-3 p-0 mt-2 mt-md-0 row mx-auto text-center">
        <div id="d1" style="border-top:10px solid black;border-left:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d2" style="border-top:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d3" style="border-top:10px solid black;border-right:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d4" style="border-left:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d5"  class="col-4 py-2 px-4">N</div>
        <div id="d6" style="border-right:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d7" style="border-bottom:10px solid black;border-left:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d8" style="border-bottom:10px solid black;" class="col-4 py-2 px-4">N</div>
        <div id="d9" style="border-bottom:10px solid black;border-right:10px solid black;" class="col-4 py-2 px-4">N</div>
      </div>
      <div id="player-2" class="col-md-4 d-none d-md-block mx-auto text-center">
        <div class="player-name">Computer</div>
        <div class="player-score">0</div>
      </div>
      <div id="game-button" class="col-12 mx-auto row my-3">
        <button id="new-game" class="ml-auto col-5 col-md-3 m-3 p-2 p-md-3">New Game</button>
        <button id="reset-game" class=" mr-auto col-5 col-md-3 m-3 p-2 p-md-3">Reset Game</button>
      </div>
      <div id="player-info" class="col-md-5 col-10 position-absolute bg-white p-3 text-center d-none">
        <div class="greeting">Let's play <br class="d-md-none">tic tac toe</div>
        <div class="my-3 row">
          <input id="username-value" style="border: 0px;border-bottom:2px solid black;" type="text" class="col-9 mx-auto text-center h2 " placeholder="Player Name">
          <span class="username-valid col-12 small text-danger text-left d-none">Please enter valid Name</span>
        </div>
        <div class="row text-center my-3 ">
          <button id="save-username" class="col-6 mx-auto btn btn-primary border h1 border-bark">SAVE</button>
        </div>
      </div>  
      <div id="game-result" class="position-absolute">
        <div id="" class="d-none result-1">
          <div id="result-win-1" class="col-5 col-md-3 display-1 py-5 pr-2 text-right">üéâYOU </div>
          <div id="result-win-2" style="margin-left: 0px;" class="col-5 col-md-3 display-1 py-5 pl-2">
            <table style="margin:0px;padding:0px;">
              <tr style="margin:0px;padding:0px;">
                <td style="margin:0px;padding:0px;"> WIN </td> 
                <td style="margin:0px;padding:0px;"><div style="transform:rotateY(180deg);" class="">üéâ</div></td>    
              </tr>
            </table>
          </div>  
        </div>
        
        <div id="" class="d-none result-2">
          <div id="result-lose-1" class="col-5 col-md-3 display-1 py-5 text-right">YOU L</div>
          <div id="result-lose-2" style="margin-left: 0px;" class="col-5 col-md-3 display-1 py-5">
            <table style="margin:0px;padding:0px;">
              <tr style="margin:0px;padding:0px;">
                <td style="margin:0px;padding:0px;">OSE</td> 
                <td style="margin:0px;padding:0px;"><div style="transform:rotateY(180deg);" class="">‚òπÔ∏è</div></td>    
              </tr>
            </table>
          </div>  
        </div>
        <div id="" class="d-none result-3">
          <div id="result-tie-1" class="col-5 col-md-3 display-1 py-5 text-right">TI</div>
          <div id="result-tie-2" class="col-5 col-md-3 display-1 py-5">EüôÉ</div>  
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
      var board = [' ',' ',' ',' ',' ',' ',' ',' ',' ',' '];
      $(document).ready(function(){
        checkSession();
        if(!checkUser()){
          $('#player-info').removeClass('d-none');
        }
        player = localStorage.getItem('user');
        if ( player == null ){
          $('#player-1 .player-score').html("0");
        }else{
          $('#player-1 .player-score').html(`${localStorage.getItem('user')}`);
        }
        player = localStorage.getItem('computer');
        if ( player == null ){
          $('#player-2 .player-score').html("0");
          $('#player-3 .player-score').html("0");
        }else{
          $('#player-2 .player-score').html(`${localStorage.getItem('computer')}`);
          $('#player-3 .player-score').html(`${localStorage.getItem('computer')}`);
        }
        $("#game-board div").mouseover(function(){
          if ($(this).html()=="N"){
            $(this).css('color',"red");
          }
          $(this).css('background-color',"red");
        });
        $("#game-board div").mouseleave(function(){
          if ($(this).html()=="N"){
            $(this).css('color',"#ee8383");
          }
          $(this).css('background-color',"#ee8383");
        });
        $("#game-board div").click(function(){
          boardData=$(this).html();
          if (boardData=="N"){
            $(this).html('X').css('color','black');
            inputValue = $(this).attr('id');
            startGame(inputValue[inputValue.length-1]);
          }
        });
        
        $('#save-username').click(async function(){
          username=$('#username-value').val();
          if(username.length!=0 && username.match(/^[0-9a-zA-Z\s]+$/)){
            localStorage.setItem('username',username);
            $("#player-info").addClass('d-none');
            $("#player-1 .player-name").html(`${username.split(" ")[0]}`);
          }else{
            $('.username-valid').removeClass('d-none').addClass('shake');
            await sleep(2000);
            $(".username-valid").addClass('d-none').removeClass('shake');
            }
        });
        $("#new-game").mouseover(function(){
          $(this).css('background-color','red');
        });
        $("#new-game").mouseleave(function(){
          $(this).css('background-color','white');
        });
        
        $("#reset-game").mouseover(function(){
          $(this).css('background-color','red');
        });
        $("#reset-game").mouseleave(function(){
          $(this).css('background-color','white');
        });
        $("#new-game").click(function(){
          newgame();
        });
        $("#reset-game").click(function(){
          resetGame();
        });
      });
      function checkSession(){
        sessionValid = new Date().getTime();
        if (!localStorage.getItem('sessionTimeout')){
          localStorage.setItem('sessionTimeout',sessionValid + (24 * 60 * 60 * 1000));
        }else{
          if(parseInt(localStorage.getItem('sessionTimeout'))<sessionValid){
            resetGame();
          }
        }
      }
      function checkUser(){
        if(!localStorage.getItem('username')){
          return false;
        }else{
         var username = localStorage.getItem('username').split(" ")[0]
          $("#player-1 .player-name").html(`${username}`);
          return true;
        }
      }
      function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      function insertLetter(letter,pos){
        board[pos] = letter;
      }
      function spaceIsFree(pos){
      return board[pos] == ' ';  
      }
      function isBoardFull(board){
        if (board.lastIndexOf(' ')>0){
          return false;
        }else{
          return true;
        }
      }
      function isWinner(b,l){
        return (b[1] == l && b[2] == l && b[3] == l ) || (b[4] == l && b[5] == l && b[6] == l ) || (b[7] == l && b[8] == l && b[9] == l ) || (b[1] == l && b[4] == l && b[7] == l ) || (b[2] == l && b[5] == l && b[8] == l ) || (b[3] == l && b[6] == l && b[9] == l ) || (b[1] == l && b[5] == l && b[9] == l ) || (b[3] == l && b[5] == l && b[7] == l )
      }
      function playerMove(userInput){
        run = true;
        while(run){
          move = parseInt(userInput)
          if (Number.isInteger(move)){ 
            move = parseInt(move);
            if(move>0 && move<10){
              if (spaceIsFree(move)){
                run = false;
                insertLetter('X',move);
              }
            }else{
              console.log('Please type a number b/w 1-9');
            }
          }else{
            console.log('Please type a Number');
          }
        }
      }
      function computerMove(){
        let possibleMoves=[]
        for(i=1;i<10;i++){
          if(board[i]==' '){
            possibleMoves.push(i);
          }
        }
        let move = 0;
        trigger=['O','X'];
        for(i=0;i<2;i++){
          for(j=0;j<possibleMoves.length;j++){
            boardCopy=board.slice();
            boardCopy[possibleMoves[j]] = trigger[i]
            if (isWinner(boardCopy,trigger[i])) {
              move = possibleMoves[j]
              return move;
            }
          }
        }
        cornersOpen = []
        for(i=1;i<possibleMoves.length;i++){
          if(possibleMoves[i]==1 || possibleMoves[i]==3 || possibleMoves[i]==7 || possibleMoves[i]==9) {
            cornersOpen.push(possibleMoves[i])
          }
        }
        if (cornersOpen.length>0){
          move = selectRandom(cornersOpen);
          return move;
        }
        if (possibleMoves.indexOf(5)!=-1){
          return 5;
        }
        edgeOpen = []
        for(i=1;i<possibleMoves.length;i++){
          if(possibleMoves[i] % 2 == 0) {
            edgeOpen.push(possibleMoves[i])
          }
        }
        if (edgeOpen.length>0){
          move = selectRandom(edgeOpen);
          return move;
        }
        return move;
      }
      function selectRandom(li){
        ln = li.length;
        r = Math.floor(Math.random() * (ln - 0)) + 0;
        return  li[r];
      }
      async function startGame(userInput){
        for(i=0;i<1;i++){
          if(!(isBoardFull(board))){
            if(!(isWinner(board,'O'))){
              playerMove(userInput);
            }else{
              scoreUpdate('O');
              break;
            }
            if(!(isWinner(board,'X'))){
              move = computerMove();
              if(move==0){
                $('.result-3').removeClass('d-none').attr('id','result-tie');
                await sleep(3000);
                $(window).on({
                  click:function(){
                    $('.result-3').addClass('d-none').removeAttr('id');
                    newgame();
                  },
                  keypress:function(){
                    $('.result-3').addClass('d-none').removeAttr('id');
                    newgame();
                  }
                });
              }else{
                insertLetter('O',move);
                $('#d'+move).html('O').css('color','black');
                if(isWinner(board,'O')){
                  scoreUpdate('O');
                $('.result-2').removeClass('d-none').attr('id','result-lose');
                await sleep(3000);
                $(window).on({
                  click:function(){
                    $('.result-2').addClass('d-none').removeAttr('id');
                    newgame();
                  },
                  keypress:function(){
                    $('.result-2').addClass('d-none').removeAttr('id');
                    newgame();
                  }
                })
                break;
                  }
              }
            }else{            
              scoreUpdate('X');
              $('.result-1').removeClass('d-none').attr('id','result-win');
              if(window.innerWidth >1200 && window.innerHeight>600){
                confettiLarge.start(2000,2000)
              }else{
                confetti.start(2000,2000)
              }
      
              await sleep(3000);
              $(window).on({
                click:function(){
                  $('.result-1').addClass('d-none').removeAttr('id');
                  newgame();
                },
                keypress:function(){
                  $('.result-1').addClass('d-none').removeAttr('id');
                  newgame();
                }
              })
            }
          }else{
          }
        }
      }  
      function scoreUpdate(player){
        var winner = '';
        if(player=="O"){
          winner = 'computer';
        }else{
          winner = 'user'; 
        }
        if(localStorage.getItem(winner)){
          localStorage.setItem(winner,parseInt(localStorage.getItem(winner))+1);
        }else{
          localStorage.setItem(winner,1);
          if(!localStorage.getItem('sessionTimeout')){
            sessionValid = new Date().getTime();
            sessionValid = sessionValid + (24 * 60 * 60 * 1000);
            localStorage.setItem('sessionTimeout',sessionValid);
          }
        }
        if(winner == 'user'){
          $("#player-1 .player-score").html(`${localStorage.getItem('user')}`);
        }else{
          $("#player-2 .player-score").html(`${localStorage.getItem('computer')}`);
          $("#player-3 .player-score").html(`${localStorage.getItem('computer')}`);
        }
      }  
      function newgame(){
        window.location.reload();
      }
      function resetSession(){
          localStorage.removeItem('user');
          localStorage.removeItem('computer');
      }
      function resetGame(){
        localStorage.clear();
        window.location.reload();
      }
  </script>
  </body>
</html>
